<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="Dikamon.Pages.MyKitchenPage"
             Title="Konyhám">

    <Grid RowDefinitions="Auto,*" Padding="0">
        <!-- Header -->
        <Grid Grid.Row="0" 
              BackgroundColor="#C3A064"
              Padding="20,20,20,20">
            <StackLayout>
                <Label Text="Konyhám" 
                       FontFamily="Tiny5" 
                       FontSize="28" 
                       HorizontalOptions="Center"
                       TextColor="#26283b"/>
                <Label Text="Szerezd meg hát mind!" 
                       FontFamily="Tiny5" 
                       FontSize="16" 
                       HorizontalOptions="Center"
                       TextColor="#26283b"/>

                <!-- Search Bar and New Item Button -->
                <Grid ColumnDefinitions="Auto,*" Margin="0,15,0,0" ColumnSpacing="10">
                    <Button Grid.Column="0"
                            Text="Új"
                            BackgroundColor="#26283b"
                            TextColor="White"
                            CornerRadius="5"
                            HeightRequest="40"
                            WidthRequest="80"
                            Command="{Binding AddNewItemCommand}"/>

                    <Grid Grid.Column="1" ColumnDefinitions="*,Auto">
                        <Frame Grid.Column="0" 
                               Padding="10,0" 
                               BorderColor="Transparent"
                               BackgroundColor="White"
                               CornerRadius="5"
                               HasShadow="False">
                            <Grid ColumnDefinitions="*,Auto">
                                <Entry Grid.Column="0"
                                       Placeholder="Keresés"
                                       Text="{Binding SearchText}"
                                       VerticalOptions="Center"
                                       BackgroundColor="Transparent"/>
                                <Label Grid.Column="1"
                                       Text="Mutasd mind"
                                       VerticalOptions="Center"
                                       TextColor="#26283b"
                                       FontFamily="Tiny5"/>
                            </Grid>
                        </Frame>
                        <Button Grid.Column="1"
                                Text="🔍"
                                WidthRequest="40"
                                BackgroundColor="White"
                                TextColor="#26283b"
                                CornerRadius="5"
                                Margin="5,0,0,0"
                                Command="{Binding SearchCommand}"/>
                    </Grid>
                </Grid>
            </StackLayout>
        </Grid>

        <!-- Main Content - Categories or Items -->
        <Grid Grid.Row="1" 
              BackgroundColor="#D8F2E3" 
              Padding="10">

            <!-- Category View (Default) -->
            <Grid x:Name="CategoriesContainer" IsVisible="{Binding IsCategoryViewVisible}">
                <CollectionView x:Name="CategoriesView"
                               ItemsSource="{Binding Categories}"
                               SelectionMode="Single">
                    <CollectionView.ItemsLayout>
                        <GridItemsLayout Orientation="Vertical" 
                                         Span="2" 
                                         HorizontalItemSpacing="10" 
                                         VerticalItemSpacing="10"/>
                    </CollectionView.ItemsLayout>
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Frame Padding="0" 
                                   CornerRadius="10" 
                                   HasShadow="False"
                                   BackgroundColor="Transparent"
                                   BorderColor="Transparent">
                                <Grid RowDefinitions="*,Auto">
                                    <!-- Category Image -->
                                    <Frame Grid.Row="0"
                                           CornerRadius="10"
                                           Padding="0"
                                           HasShadow="False"
                                           BackgroundColor="Black">
                                        <Grid>
                                            <Image Source="{Binding Image}"
                                                   Aspect="AspectFill"/>
                                            <Label Text="{Binding Name}"
                                                   TextColor="White"
                                                   FontFamily="Tiny5"
                                                   FontSize="20"
                                                   HorizontalOptions="Center"
                                                   VerticalOptions="Center"
                                                   FontAttributes="Bold"/>
                                        </Grid>
                                    </Frame>
                                </Grid>
                                <Frame.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.SelectCategoryCommand}" 
                                                          CommandParameter="{Binding .}" />
                                </Frame.GestureRecognizers>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </Grid>

            <!-- Items View (When category is selected) -->
            <Grid x:Name="ItemsContainer" 
                  IsVisible="{Binding IsItemViewVisible}"
                  RowDefinitions="Auto,*,Auto">

                <!-- Back button and Category Title -->
                <StackLayout Grid.Row="0" 
                             Orientation="Horizontal"
                             Margin="5,0,0,10">
                    <Button Text="←"
                            FontSize="20"
                            BackgroundColor="Transparent"
                            TextColor="#26283b"
                            WidthRequest="40"
                            HeightRequest="40"
                            Padding="0"
                            Command="{Binding BackToCategoriesCommand}"/>
                    <Label Text="{Binding SelectedCategory.Name}"
                           FontFamily="Tiny5"
                           FontSize="20"
                           VerticalOptions="Center"
                           TextColor="#26283b"/>
                </StackLayout>

                <!-- Items Grid -->
                <CollectionView Grid.Row="1"
                               ItemsSource="{Binding CurrentPageItems}"
                               SelectionMode="None">
                    <CollectionView.ItemsLayout>
                        <GridItemsLayout Orientation="Vertical" 
                                         Span="3" 
                                         HorizontalItemSpacing="10" 
                                         VerticalItemSpacing="10"/>
                    </CollectionView.ItemsLayout>
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Frame Padding="0" 
                                   CornerRadius="10" 
                                   HasShadow="False"
                                   BackgroundColor="White"
                                   BorderColor="Transparent">
                                <Grid RowDefinitions="*,Auto,Auto">
                                    <!-- Item Image -->
                                    <Frame Grid.Row="0"
                                           CornerRadius="10"
                                           Padding="0"
                                           HasShadow="False">
                                        <Image Source="{Binding Image}"
                                               Aspect="AspectFill"
                                               HeightRequest="120"/>
                                    </Frame>
                                    <!-- Item Name -->
                                    <Label Grid.Row="1"
                                           Text="{Binding Name}"
                                           FontFamily="Tiny5"
                                           FontSize="16"
                                           Padding="10,5"
                                           HorizontalOptions="Start"/>
                                    <!-- Item Quantity -->
                                    <StackLayout Grid.Row="2"
                                                 Orientation="Horizontal"
                                                 Padding="10,0,10,10">
                                        <Label Text="{Binding Quantity, StringFormat='{0} darab'}"
                                               TextColor="#26283b"
                                               FontSize="14"/>
                                        <StackLayout Orientation="Horizontal"
                                                     HorizontalOptions="EndAndExpand">
                                            <Button Text="ℹ"
                                                    FontSize="16"
                                                    BackgroundColor="#26283b"
                                                    TextColor="White"
                                                    CornerRadius="15"
                                                    WidthRequest="30"
                                                    HeightRequest="30"
                                                    Padding="0"
                                                    Margin="0,0,5,0"
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.InfoCommand}"
                                                    CommandParameter="{Binding .}"/>
                                            <Button Text="↓"
                                                    FontSize="16"
                                                    BackgroundColor="#26283b"
                                                    TextColor="White"
                                                    CornerRadius="15"
                                                    WidthRequest="30"
                                                    HeightRequest="30"
                                                    Padding="0"
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DecreaseQuantityCommand}"
                                                    CommandParameter="{Binding .}"/>
                                        </StackLayout>
                                    </StackLayout>
                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <!-- Pagination Controls -->
                <StackLayout Grid.Row="2"
                             Orientation="Horizontal"
                             HorizontalOptions="Center"
                             Margin="0,10,0,0">
                    <Button Text="&lt;"
                            IsEnabled="{Binding CanGoToPreviousPage}"
                            Command="{Binding PreviousPageCommand}"
                            WidthRequest="40"
                            HeightRequest="40"
                            CornerRadius="20"
                            BackgroundColor="#26283b"
                            TextColor="White"
                            Margin="5,0"/>
                    <Label Text="{Binding PaginationText}"
                           VerticalOptions="Center"
                           FontSize="14"
                           Margin="10,0"/>
                    <Button Text="&gt;"
                            IsEnabled="{Binding CanGoToNextPage}"
                            Command="{Binding NextPageCommand}"
                            WidthRequest="40"
                            HeightRequest="40"
                            CornerRadius="20"
                            BackgroundColor="#26283b"
                            TextColor="White"
                            Margin="5,0"/>
                </StackLayout>
            </Grid>
        </Grid>
    </Grid>
</ContentPage>